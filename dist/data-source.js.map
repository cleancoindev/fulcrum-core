{"version":3,"sources":["../src/data-source.js"],"names":[],"mappings":"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","file":"data-source.js","sourcesContent":["/*\n\n  The DataSource class is a composable series of layers that can be used to\n  chain data providers together to form more complex schemes.\n\n  For example, we can setup several layers of caching and data providers:\n    * A - First look in an in-memory hash (e.g. lives until a page refresh)\n    * B - Then look in indexedDB (lives beyond a page refresh, but requires pulling from somewhere else)\n    * C - Then finally actually hit the API to get it\n\n  Given this configuration, when requesting data when it's not present at all, the request will travel\n  all the way to the end and then each layer is given a chance to process it back on the way up. Passing\n  the object back up is critical to being able to store the result at each level.\n\n  A.then(B).then(C);\n\n   get(callback)    -> A -> B -> C -\n                                   |\n   callback(object) <- A <- B <- C -\n\n  So in this configuration, when asking for a form object, the memory data source would miss and delegate\n  to the indexedDB data source, which would also miss and the API data source would end up providing the\n  record from the live API. At that point the object is passed back to the indexedDB where it can be stored\n  for the next time. After indexedDB stores it, it's passed to the memory cache so it can also store it. And\n  finally the actual original callback is invoked with the object. The next time the object is fetched, it will\n  be returned from the memory store. Unless a full page refresh happens, and indexedDB will return it first.\n\n  After the first fetch:\n\n   get(callback)    -> A    B    C\n                       |\n   callback(object) <- A    B    C\n\n  After a full page refresh\n\n   get(callback)    -> A -> B    C\n                            |\n   callback(object) <- A <- B    C\n\n*/\n\nimport async from 'async';\n\nfunction noop(...params) {\n  params[params.length - 1]();\n}\n\nexport default class DataSource {\n  constructor() {\n    this.sources = [];\n  }\n\n  get source() {\n    return this.sources[this.sources.length - 1];\n  }\n\n  invoke(dataSource, method, params, callback) {\n    const invokeCallback = (err, ...objects) => {\n      if (err) {\n        return callback(err);\n      } else if (objects[0]) {\n        return this.process(dataSource.previous, method, params, objects, callback);\n      } else if (dataSource.next) {\n        return this.invoke(dataSource.next, method, params, callback);\n      }\n\n      return callback(new Error('Unhandled request: ' + method));\n    };\n\n    const invokeArguments = params.concat([invokeCallback]);\n\n    (dataSource[method] || noop).apply(dataSource, invokeArguments);\n  }\n\n  process(dataSource, method, params, objects, callback) {\n    if (dataSource == null) {\n      return callback.apply(null, [null].concat(objects));\n    }\n\n    const processMethod = method + 'Complete';\n\n    const processCallback = (err) => {\n      if (err) {\n        return callback(err);\n      } else if (dataSource.previous) {\n        return this.process(dataSource.previous, method, params, objects, callback);\n      } else {\n        return callback.apply(null, [null].concat(objects));\n      }\n    };\n\n    const processArguments = params.concat(objects.concat([processCallback]));\n\n    (dataSource[processMethod] || noop).apply(dataSource, processArguments);\n\n    return null;\n  }\n\n  add(source) {\n    if (this.sources.length) {\n      this.sources[this.sources.length - 1].next = source;\n      source.previous = this.sources[this.sources.length - 1];\n    }\n\n    this.sources.push(source);\n\n    return this;\n  }\n\n  prepare(formID, callback) {\n    const result = {};\n\n    const tasks = {\n      form: (callback) => {\n        this.getForm(formID, (err, form) => {\n          if (err) {\n            callback(err);\n            return;\n          }\n\n          result.form = form;\n          result.form.load(this, callback);\n        });\n      },\n\n      users: (callback) => {\n        this.getUsers(null, (err, users) => {\n          if (err) {\n            callback(err);\n            return;\n          }\n\n          result.users = users;\n          callback(err);\n        });\n      },\n\n      projects: (callback) => {\n        this.getProjects(null, (err, projects) => {\n          if (err) {\n            callback(err);\n            return;\n          }\n\n          result.projects = projects;\n          callback(err);\n        });\n      }\n    };\n\n    async.parallel(tasks, (err) => callback(err, result));\n  }\n\n  get root() {\n    return this.sources[0];\n  }\n\n  getChoiceList(id, callback) {\n    this.invoke(this.root, 'getChoiceList', [id], callback);\n  }\n\n  getClassificationSet(id, callback) {\n    this.invoke(this.root, 'getClassificationSet', [id], callback);\n  }\n\n  getForm(id, callback) {\n    this.invoke(this.root, 'getForm', [id], callback);\n  }\n\n  getRecord(id, form, callback) {\n    this.invoke(this.root, 'getRecord', [id, form], callback);\n  }\n\n  getRecords(form, params, callback) {\n    this.invoke(this.root, 'getRecords', [form, params], callback);\n  }\n\n  getUsers(params, callback) {\n    this.invoke(this.root, 'getUsers', [params], callback);\n  }\n\n  getProjects(params, callback) {\n    this.invoke(this.root, 'getProjects', [params], callback);\n  }\n\n  getPhoto(id, callback) {\n    this.invoke(this.root, 'getPhoto', [id], callback);\n  }\n\n  getAudio(id, callback) {\n    this.invoke(this.root, 'getAudio', [id], callback);\n  }\n\n  getAudioTrack(id, callback) {\n    this.invoke(this.root, 'getAudioTrack', [id], callback);\n  }\n\n  getVideo(id, callback) {\n    this.invoke(this.root, 'getVideo', [id], callback);\n  }\n\n  getVideoTrack(id, callback) {\n    this.invoke(this.root, 'getVideoTrack', [id], callback);\n  }\n\n  createPhoto(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'createPhoto', [accessKey, file, progress], callback);\n  }\n\n  createVideo(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'createVideo', [accessKey, file, progress], callback);\n  }\n\n  createAudio(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'createAudio', [accessKey, file, progress], callback);\n  }\n\n  createSignature(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'createSignature', [accessKey, file, progress], callback);\n  }\n\n  saveVideoTrack(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'saveVideoTrack', [accessKey, file, progress], callback);\n  }\n\n  saveAudioTrack(accessKey, file, progress, callback) {\n    this.invoke(this.root, 'saveAudioTrack', [accessKey, file, progress], callback);\n  }\n\n  saveRecord(record, callback) {\n    this.invoke(this.root, 'saveRecord', [record], callback);\n  }\n\n  deleteRecord(record, callback) {\n    this.invoke(this.root, 'deleteRecord', [record], callback);\n  }\n}\n"]}