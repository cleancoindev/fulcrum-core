{"version":3,"sources":["../src/form.js"],"names":["Form","attributes","updateFromAPIAttributes","attrs","_id","id","_name","name","_description","description","_elementsJSON","elements","_elements","_statusFieldJSON","status_field","_statusField","_script","script","_geometryRequired","geometry_required","_geometryTypes","geometry_types","_reportTemplatesJSON","report_templates","_boundingBox","bounding_box","_version","version","_createdAt","parseISOTimestamp","created_at","_updatedAt","updated_at","_image","image","_imageLarge","image_large","_imageSmall","image_small","_imageThumbnail","image_thumbnail","_projectEnabled","projects_enabled","_assignmentEnabled","assignment_enabled","_autoAssign","auto_assign","_hiddenOnDashboard","hidden_on_dashboard","title_field_keys","record_title_key","_titleFieldKeysJSON","load","dataSource","callback","_schemaLoaded","loadElements","allElements","element","push","each","cb","err","createRecord","record","applyDefaultValuesForElements","formValues","get","key","elementsByKey","find","dataName","elementsByDataName","toJSON","json","JSON","parse","stringify","isAssignmentEnabled","isHiddenOnDashboard","isAutoAssign","isProjectEnabled","isGeometryRequired","titleFieldKeys","reportTemplates","boundingBox","formatISOTimestamp","createdAt","updatedAt","resetOverrides","statusField","_overrideManualLocationEnabled","_overrideMediaGalleryEnabled","length","override","_overrideEditDurationsEnabled","overrideManualLocationEnabled","overrideMediaGalleryEnabled","overrideEditDurationsEnabled","includeInto"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;IAEqBA,I;AACnB,gBAAYC,UAAZ,EAAwB;AAAA;;AACtB,SAAKC,uBAAL,CAA6BD,UAA7B;AACD;;iBAEDC,uB,oCAAwBC,K,EAAO;AAC7B,QAAMF,aAAaE,SAAS,EAA5B;;AAEA,SAAKC,GAAL,GAAWH,WAAWI,EAAtB;AACA,SAAKC,KAAL,GAAaL,WAAWM,IAAxB;AACA,SAAKC,YAAL,GAAoBP,WAAWQ,WAA/B;AACA,SAAKC,aAAL,GAAqBT,WAAWU,QAAhC;AACA,SAAKC,SAAL,GAAiB,IAAjB;AACA,SAAKC,gBAAL,GAAwBZ,WAAWa,YAAnC;AACA,SAAKC,YAAL,GAAoB,IAApB;AACA,SAAKC,OAAL,GAAef,WAAWgB,MAA1B;AACA,SAAKC,iBAAL,GAAyB,CAAC,CAACjB,WAAWkB,iBAAtC;AACA,SAAKC,cAAL,GAAsBnB,WAAWoB,cAAjC;AACA,SAAKC,oBAAL,GAA4BrB,WAAWsB,gBAAvC;AACA,SAAKC,YAAL,GAAoBvB,WAAWwB,YAA/B;AACA,SAAKC,QAAL,GAAgBzB,WAAW0B,OAA3B;AACA,SAAKC,UAAL,GAAkB,oBAAUC,iBAAV,CAA4B5B,WAAW6B,UAAvC,CAAlB;AACA,SAAKC,UAAL,GAAkB,oBAAUF,iBAAV,CAA4B5B,WAAW+B,UAAvC,CAAlB;AACA,SAAKC,MAAL,GAAchC,WAAWiC,KAAzB;AACA,SAAKC,WAAL,GAAmBlC,WAAWmC,WAA9B;AACA,SAAKC,WAAL,GAAmBpC,WAAWqC,WAA9B;AACA,SAAKC,eAAL,GAAuBtC,WAAWuC,eAAlC;;AAEA,SAAKC,eAAL,GAAuBxC,WAAWyC,gBAAX,IAA+B,IAA/B,GAAsC,CAAC,CAACzC,WAAWyC,gBAAnD,GAAsE,IAA7F;AACA,SAAKC,kBAAL,GAA0B1C,WAAW2C,kBAAX,IAAiC,IAAjC,GAAwC,CAAC,CAAC3C,WAAW2C,kBAArD,GAA0E,IAApG;AACA,SAAKC,WAAL,GAAmB5C,WAAW6C,WAAX,IAA0B,IAA1B,GAAiC,CAAC,CAAC7C,WAAW6C,WAA9C,GAA4D,KAA/E;AACA,SAAKC,kBAAL,GAA0B9C,WAAW+C,mBAAX,IAAkC,IAAlC,GAAyC,CAAC,CAAC/C,WAAW+C,mBAAtD,GAA4E,KAAtG;;AAEA,QAAI/C,WAAWgD,gBAAX,IAA+BhD,WAAWiD,gBAA9C,EAAgE;AAC9D,WAAKC,mBAAL,GAA2BlD,WAAWgD,gBAAX,IAA+B,CAAEhD,WAAWiD,gBAAb,CAA1D;AACD,KAFD,MAEO;AACL,WAAKC,mBAAL,GAA2B,EAA3B;AACD;AACF,G;;iBAkBDC,I,iBAAKC,U,EAAYC,Q,EAAU;AACzB,QAAI,KAAKC,aAAT,EAAwB;AACtBD;AACA;AACD;;AAED,SAAKC,aAAL,GAAqB,IAArB;;AAEA,QAAMC,eAAe,EAArB;;AAEA,yBAAsB,KAAKC,WAA3B,kHAAwC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,UAA7BC,OAA6B;;AACtC,UAAIA,QAAQN,IAAZ,EAAkB;AAChBI,qBAAaG,IAAb,CAAkBD,OAAlB;AACD;AACF;;AAED,oBAAME,IAAN,CAAWJ,YAAX,EAAyB,UAACE,OAAD,EAAUG,EAAV,EAAiB;AACxCH,cAAQN,IAAR,CAAaC,UAAb,EAAyB,UAACS,GAAD,EAAS;AAChC,YAAIA,GAAJ,EAAS;AACP;AACA;AACA;AACA;AACA;AACD;;AAEDD;AACD,OAVD;AAWD,KAZD,EAYGP,QAZH;AAaD,G;;iBAEDS,Y,yBAAa9D,U,EAAY;AACvB,QAAM+D,SAAS,qBAAW/D,UAAX,EAAuB,IAAvB,CAAf;;AAEA,4BAAcgE,6BAAd,CAA4C,KAAKtD,QAAjD,EAC4CqD,OAAOE,UADnD,EAE4CF,MAF5C;;AAIA,WAAOA,MAAP;AACD,G;;iBASDG,G,gBAAIC,G,EAAK;AACP,WAAO,KAAKC,aAAL,CAAmBD,GAAnB,CAAP;AACD,G;;iBAEDE,I,iBAAKC,Q,EAAU;AACb,WAAO,KAAKC,kBAAL,CAAwBD,QAAxB,CAAP;AACD,G;;iBA0CDE,M,qBAAS;AACP,QAAMC,OAAO,EAAb;;AAEAA,SAAKrE,EAAL,GAAU,KAAKA,EAAL,IAAW,IAArB;AACAqE,SAAKnE,IAAL,GAAY,KAAKA,IAAL,IAAa,IAAzB;AACAmE,SAAKjE,WAAL,GAAmB,KAAKA,WAAL,IAAoB,IAAvC;AACAiE,SAAKzD,MAAL,GAAc,KAAKA,MAAL,IAAe,IAA7B;AACAyD,SAAK/D,QAAL,GAAgBgE,KAAKC,KAAL,CAAWD,KAAKE,SAAL,CAAe,KAAKnE,aAApB,CAAX,CAAhB;AACAgE,SAAK9B,kBAAL,GAA0B,KAAKkC,mBAA/B;AACAJ,SAAK1B,mBAAL,GAA2B,KAAK+B,mBAAhC;AACAL,SAAK5B,WAAL,GAAmB,KAAKkC,YAAxB;AACAN,SAAKhC,gBAAL,GAAwB,KAAKuC,gBAA7B;AACAP,SAAKvD,iBAAL,GAAyB,KAAK+D,kBAA9B;AACAR,SAAKrD,cAAL,GAAsB,KAAKD,cAA3B;AACAsD,SAAKzB,gBAAL,GAAwB,KAAKkC,cAA7B;AACAT,SAAKnD,gBAAL,GAAwB,KAAK6D,eAA7B;AACAV,SAAKjD,YAAL,GAAoB,KAAK4D,WAAzB;AACAX,SAAK/C,OAAL,GAAe,KAAKA,OAApB;AACA+C,SAAK5C,UAAL,GAAkB,oBAAUwD,kBAAV,CAA6B,KAAKC,SAAlC,CAAlB;AACAb,SAAK1C,UAAL,GAAkB,oBAAUsD,kBAAV,CAA6B,KAAKE,SAAlC,CAAlB;;AAEA,QAAI,KAAK3E,gBAAT,EAA2B;AACzB6D,WAAK5D,YAAL,GAAoB6D,KAAKC,KAAL,CAAWD,KAAKE,SAAL,CAAe,KAAKhE,gBAApB,CAAX,CAApB;AACD;;AAED,WAAO6D,IAAP;AACD,G;;iBAkEDe,c,6BAAiB;AACf,0BAAsB,KAAK9E,QAA3B,yHAAqC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,UAA1B+C,OAA0B;;AACnCA,cAAQ+B,cAAR;AACD;;AAED,SAAKC,WAAL,CAAiBD,cAAjB;;AAEA,SAAKE,8BAAL,GAAsC,IAAtC;AACA,SAAKC,4BAAL,GAAoC,IAApC;AACD,G;;;;wBArNQ;AACP,aAAO,KAAKxF,GAAZ;AACD;;;wBAEa;AACZ,aAAO,KAAKsB,QAAZ;AACD;;;wBAEe;AACd,aAAO,KAAKE,UAAZ;AACD;;;wBAEe;AACd,aAAO,KAAKG,UAAZ;AACD;;;wBA2CiB;AAChB,UAAI,CAAC,KAAKhB,YAAV,EAAwB;AACtB,aAAKA,YAAL,GAAoB,4BAAkB,IAAlB,EAAwB,KAAKF,gBAA7B,CAApB;AACD;AACD,aAAO,KAAKE,YAAZ;AACD;;;wBAUqB;AACpB,aAAO,KAAP;AACD;;;wBAEsB;AACrB,aAAO,KAAK0B,eAAZ;AACD;;;wBAEyB;AACxB,aAAO,KAAKE,kBAAZ;AACD;;;wBAEkB;AACjB,aAAO,KAAKE,WAAZ;AACD;;;wBAEyB;AACxB,aAAO,KAAKE,kBAAZ;AACD;;;wBAEiB;AAChB,aAAO,KAAKvB,YAAZ;AACD;;;wBAEW;AACV,aAAO,KAAKS,MAAZ;AACD;;;wBAEgB;AACf,aAAO,KAAKE,WAAZ;AACD;;;wBAEgB;AACf,aAAO,KAAKE,WAAZ;AACD;;;wBAEoB;AACnB,aAAO,KAAKE,eAAZ;AACD;;;wBA8BuB;AACtB,aAAO,KAAKnB,cAAL,IAAuB,KAAKA,cAAL,CAAoByE,MAApB,GAA6B,CAA3D;AACD;;;wBAEwB;AACvB,aAAO,KAAK3E,iBAAZ;AACD;;;wBAEU;AACT,aAAO,KAAKZ,KAAZ;AACD;;;wBAEiB;AAChB,aAAO,KAAKE,YAAZ;AACD;;;wBAEY;AACX,aAAO,KAAKQ,OAAZ;AACD;;;wBAEoB;AACnB,aAAO,KAAKmC,mBAAL,IAA4B,EAAnC;AACD;;;wBAEqB;AACpB,aAAO,KAAK7B,oBAAL,IAA6B,EAApC;AACD;;;wBAEoB;AACnB,aAAO,KAAK8D,eAAL,CAAqBS,MAArB,GAA8B,KAAKT,eAAL,CAAqB,CAArB,CAA9B,GAAwD,IAA/D;AACD;;;sBAEiCU,Q,EAAU;AAC1C,WAAKH,8BAAL,GAAsCG,QAAtC;AACD;;;wBAE6B;AAC5B,aAAO,KAAKH,8BAAL,IAAuC,IAAvC,GAA8C,CAAC,CAAC,KAAKA,8BAArD,GAAsF,IAA7F;AACD;;;sBAE+BG,Q,EAAU;AACxC,WAAKF,4BAAL,GAAoCE,QAApC;AACD;;;wBAE2B;AAC1B,aAAO,KAAKF,4BAAL,IAAqC,IAArC,GAA4C,CAAC,CAAC,KAAKA,4BAAnD,GAAkF,IAAzF;AACD;;;sBAEgCE,Q,EAAU;AACzC,WAAKC,6BAAL,GAAqCD,QAArC;AACD;;;wBAE4B;AAC3B,aAAO,KAAKC,6BAAL,IAAsC,IAAtC,GAA6C,CAAC,CAAC,KAAKA,6BAApD,GAAoF,IAA3F;AACD;;;wBAEoB;AACnB,aAAO;AACLC,uCAA+B,KAAKL,8BAD/B;AAELM,qCAA6B,KAAKL,4BAF7B;AAGLM,sCAA8B,KAAKH;AAH9B,OAAP;AAKD;;;;;;kBAlPkB/F,I;;;AAgQrB,wBAAcmG,WAAd,CAA0BnG,IAA1B","file":"form.js","sourcesContent":["import ChildElements from './elements/child-elements';\nimport StatusElement from './elements/status-element';\nimport DefaultValues from './values/default-values';\nimport Record from './record';\nimport async from 'async';\nimport DateUtils from './utils/date-utils';\n\nexport default class Form {\n  constructor(attributes) {\n    this.updateFromAPIAttributes(attributes);\n  }\n\n  updateFromAPIAttributes(attrs) {\n    const attributes = attrs || {};\n\n    this._id = attributes.id;\n    this._name = attributes.name;\n    this._description = attributes.description;\n    this._elementsJSON = attributes.elements;\n    this._elements = null;\n    this._statusFieldJSON = attributes.status_field;\n    this._statusField = null;\n    this._script = attributes.script;\n    this._geometryRequired = !!attributes.geometry_required;\n    this._geometryTypes = attributes.geometry_types;\n    this._reportTemplatesJSON = attributes.report_templates;\n    this._boundingBox = attributes.bounding_box;\n    this._version = attributes.version;\n    this._createdAt = DateUtils.parseISOTimestamp(attributes.created_at);\n    this._updatedAt = DateUtils.parseISOTimestamp(attributes.updated_at);\n    this._image = attributes.image;\n    this._imageLarge = attributes.image_large;\n    this._imageSmall = attributes.image_small;\n    this._imageThumbnail = attributes.image_thumbnail;\n\n    this._projectEnabled = attributes.projects_enabled != null ? !!attributes.projects_enabled : true;\n    this._assignmentEnabled = attributes.assignment_enabled != null ? !!attributes.assignment_enabled : true;\n    this._autoAssign = attributes.auto_assign != null ? !!attributes.auto_assign : false;\n    this._hiddenOnDashboard = attributes.hidden_on_dashboard != null ? !!attributes.hidden_on_dashboard : false;\n\n    if (attributes.title_field_keys || attributes.record_title_key) {\n      this._titleFieldKeysJSON = attributes.title_field_keys || [ attributes.record_title_key ];\n    } else {\n      this._titleFieldKeysJSON = [];\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  get version() {\n    return this._version;\n  }\n\n  get createdAt() {\n    return this._createdAt;\n  }\n\n  get updatedAt() {\n    return this._updatedAt;\n  }\n\n  load(dataSource, callback) {\n    if (this._schemaLoaded) {\n      callback();\n      return;\n    }\n\n    this._schemaLoaded = true;\n\n    const loadElements = [];\n\n    for (const element of this.allElements) {\n      if (element.load) {\n        loadElements.push(element);\n      }\n    }\n\n    async.each(loadElements, (element, cb) => {\n      element.load(dataSource, (err) => {\n        if (err) {\n          // TODO(zhm) We need a parameter to control what happens when there's an error. We don't\n          // want to throw right here because some actual forms have orphaned objects. We can't have this\n          // blow up here because in a migration we need to keep going even when a form is 'slightly bogus'.\n          // In some cases it might be desirable to have more strict verification of the choice lists and\n          // classification sets.\n        }\n\n        cb();\n      });\n    }, callback);\n  }\n\n  createRecord(attributes) {\n    const record = new Record(attributes, this);\n\n    DefaultValues.applyDefaultValuesForElements(this.elements,\n                                                record.formValues,\n                                                record);\n\n    return record;\n  }\n\n  get statusField() {\n    if (!this._statusField) {\n      this._statusField = new StatusElement(this, this._statusFieldJSON);\n    }\n    return this._statusField;\n  }\n\n  get(key) {\n    return this.elementsByKey[key];\n  }\n\n  find(dataName) {\n    return this.elementsByDataName[dataName];\n  }\n\n  get hasHiddenParent() {\n    return false;\n  }\n\n  get isProjectEnabled() {\n    return this._projectEnabled;\n  }\n\n  get isAssignmentEnabled() {\n    return this._assignmentEnabled;\n  }\n\n  get isAutoAssign() {\n    return this._autoAssign;\n  }\n\n  get isHiddenOnDashboard() {\n    return this._hiddenOnDashboard;\n  }\n\n  get boundingBox() {\n    return this._boundingBox;\n  }\n\n  get image() {\n    return this._image;\n  }\n\n  get imageLarge() {\n    return this._imageLarge;\n  }\n\n  get imageSmall() {\n    return this._imageSmall;\n  }\n\n  get imageThumbnail() {\n    return this._imageThumbnail;\n  }\n\n  toJSON() {\n    const json = {};\n\n    json.id = this.id || null;\n    json.name = this.name || null;\n    json.description = this.description || null;\n    json.script = this.script || null;\n    json.elements = JSON.parse(JSON.stringify(this._elementsJSON));\n    json.assignment_enabled = this.isAssignmentEnabled;\n    json.hidden_on_dashboard = this.isHiddenOnDashboard;\n    json.auto_assign = this.isAutoAssign;\n    json.projects_enabled = this.isProjectEnabled;\n    json.geometry_required = this.isGeometryRequired;\n    json.geometry_types = this._geometryTypes;\n    json.title_field_keys = this.titleFieldKeys;\n    json.report_templates = this.reportTemplates;\n    json.bounding_box = this.boundingBox;\n    json.version = this.version;\n    json.created_at = DateUtils.formatISOTimestamp(this.createdAt);\n    json.updated_at = DateUtils.formatISOTimestamp(this.updatedAt);\n\n    if (this._statusFieldJSON) {\n      json.status_field = JSON.parse(JSON.stringify(this._statusFieldJSON));\n    }\n\n    return json;\n  }\n\n  get isGeometryEnabled() {\n    return this._geometryTypes && this._geometryTypes.length > 0;\n  }\n\n  get isGeometryRequired() {\n    return this._geometryRequired;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  get description() {\n    return this._description;\n  }\n\n  get script() {\n    return this._script;\n  }\n\n  get titleFieldKeys() {\n    return this._titleFieldKeysJSON || [];\n  }\n\n  get reportTemplates() {\n    return this._reportTemplatesJSON || [];\n  }\n\n  get reportTemplate() {\n    return this.reportTemplates.length ? this.reportTemplates[0] : null;\n  }\n\n  set overrideManualLocationEnabled(override) {\n    this._overrideManualLocationEnabled = override;\n  }\n\n  get isManualLocationEnabled() {\n    return this._overrideManualLocationEnabled != null ? !!this._overrideManualLocationEnabled : true;\n  }\n\n  set overrideMediaGalleryEnabled(override) {\n    this._overrideMediaGalleryEnabled = override;\n  }\n\n  get isMediaGalleryEnabled() {\n    return this._overrideMediaGalleryEnabled != null ? !!this._overrideMediaGalleryEnabled : true;\n  }\n\n  set overrideEditDurationsEnabled(override) {\n    this._overrideEditDurationsEnabled = override;\n  }\n\n  get isEditDurationsEnabled() {\n    return this._overrideEditDurationsEnabled != null ? !!this._overrideEditDurationsEnabled : true;\n  }\n\n  get overrideValues() {\n    return {\n      overrideManualLocationEnabled: this._overrideManualLocationEnabled,\n      overrideMediaGalleryEnabled: this._overrideMediaGalleryEnabled,\n      overrideEditDurationsEnabled: this._overrideEditDurationsEnabled\n    };\n  }\n\n  resetOverrides() {\n    for (const element of this.elements) {\n      element.resetOverrides();\n    }\n\n    this.statusField.resetOverrides();\n\n    this._overrideManualLocationEnabled = null;\n    this._overrideMediaGalleryEnabled = null;\n  }\n}\n\nChildElements.includeInto(Form);\n"]}