{"version":3,"sources":["../src/form.js"],"names":[],"mappings":"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","file":"form.js","sourcesContent":["import ChildElements from './elements/child-elements';\nimport StatusElement from './elements/status-element';\nimport DefaultValues from './values/default-values';\nimport Record from './record';\nimport async from 'async';\n\nexport default class Form {\n  constructor(attributes) {\n    this.updateFromAPIAttributes(attributes);\n  }\n\n  updateFromAPIAttributes(attrs) {\n    const attributes = attrs || {};\n\n    this._id = attributes.id;\n    this._name = attributes.name;\n    this._description = attributes.description;\n    this._elementsJSON = attributes.elements;\n    this._elements = null;\n    this._statusFieldJSON = attributes.status_field;\n    this._statusField = null;\n    this._script = attributes.script;\n    this._geometryRequired = !!attributes.geometry_required;\n    this._geometryTypes = attributes.geometry_types;\n    this._reportTemplatesJSON = attributes.report_templates;\n\n    this._projectEnabled = attributes.projects_enabled != null ? !!attributes.projects_enabled : true;\n    this._assignmentEnabled = attributes.assignment_enabled != null ? !!attributes.assignment_enabled : true;\n\n    if (attributes.title_field_keys || attributes.record_title_key) {\n      this._titleFieldKeysJSON = attributes.title_field_keys || [ attributes.record_title_key ];\n    } else {\n      this._titleFieldKeysJSON = [];\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  load(dataSource, callback) {\n    if (this._schemaLoaded) {\n      callback();\n      return;\n    }\n\n    this._schemaLoaded = true;\n\n    const loadElements = [];\n\n    for (const element of this.allElements) {\n      if (element.load) {\n        loadElements.push(element);\n      }\n    }\n\n    async.each(loadElements, (element, cb) => {\n      element.load(dataSource, (err) => {\n        if (err) {\n          // TODO(zhm) We need a parameter to control what happens when there's an error. We don't\n          // want to throw right here because some actual forms have orphaned objects. We can't have this\n          // blow up here because in a migration we need to keep going even when a form is 'slightly bogus'.\n          // In some cases it might be desirable to have more strict verification of the choice lists and\n          // classification sets.\n        }\n\n        cb();\n      });\n    }, callback);\n  }\n\n  createRecord(attributes) {\n    const record = new Record(attributes, this);\n\n    DefaultValues.applyDefaultValuesForElements(this.elements,\n                                                record.formValues,\n                                                record);\n\n    return record;\n  }\n\n  get statusField() {\n    if (!this._statusField) {\n      this._statusField = new StatusElement(this, this._statusFieldJSON);\n    }\n    return this._statusField;\n  }\n\n  get(key) {\n    return this.elementsByKey[key];\n  }\n\n  find(dataName) {\n    return this.elementsByDataName[dataName];\n  }\n\n  get hasHiddenParent() {\n    return false;\n  }\n\n  get isProjectEnabled() {\n    return this._projectEnabled;\n  }\n\n  get isAssignmentEnabled() {\n    return this._assignmentEnabled;\n  }\n\n  toJSON() {\n    const json = {};\n\n    json.id = this.id || null;\n    json.name = this.name || null;\n    json.description = this.description || null;\n    json.script = this.script || null;\n    json.elements = JSON.parse(JSON.stringify(this._elementsJSON));\n    json.assignment_enabled = this.isAssignmentEnabled;\n    json.projects_enabled = this.isProjectEnabled;\n    json.geometry_required = this.isGeometryRequired;\n    json.geometry_types = this._geometryTypes;\n    json.title_field_keys = this.titleFieldKeys;\n    json.report_templates = this.reportTemplates;\n\n    if (this._statusFieldJSON) {\n      json.status_field = JSON.parse(JSON.stringify(this._statusFieldJSON));\n    }\n\n    return json;\n  }\n\n  get isGeometryEnabled() {\n    return this._geometryTypes && this._geometryTypes.length > 0;\n  }\n\n  get isGeometryRequired() {\n    return this._geometryRequired;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  get description() {\n    return this._description;\n  }\n\n  get script() {\n    return this._script;\n  }\n\n  get titleFieldKeys() {\n    return this._titleFieldKeysJSON || [];\n  }\n\n  get reportTemplates() {\n    return this._reportTemplatesJSON || [];\n  }\n\n  get reportTemplate() {\n    return this.reportTemplates.length ? this.reportTemplates[0] : null;\n  }\n\n  set overrideManualLocationEnabled(override) {\n    this._overrideManualLocationEnabled = override;\n  }\n\n  get isManualLocationEnabled() {\n    return this._overrideManualLocationEnabled != null ? !!this._overrideManualLocationEnabled : true;\n  }\n\n  set overrideMediaGalleryEnabled(override) {\n    this._overrideMediaGalleryEnabled = override;\n  }\n\n  get isMediaGalleryEnabled() {\n    return this._overrideMediaGalleryEnabled != null ? !!this._overrideMediaGalleryEnabled : true;\n  }\n\n  resetOverrides() {\n    for (const element of this.elements) {\n      element.resetOverrides();\n    }\n\n    this.statusField.resetOverrides();\n\n    this.overrideManualLocationEnabled = null;\n    this.overrideMediaGalleryEnabled = null;\n  }\n}\n\nChildElements.includeInto(Form);\n"]}