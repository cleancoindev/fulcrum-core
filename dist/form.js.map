{"version":3,"sources":["../src/form.js"],"names":["Form","attributes","updateFromAPIAttributes","attrs","_id","id","_name","name","_description","description","_elementsJSON","elements","_elements","_statusFieldJSON","status_field","_statusField","_script","script","_geometryRequired","geometry_required","_geometryTypes","geometry_types","_reportTemplatesJSON","report_templates","_boundingBox","bounding_box","_version","version","_createdAt","DateUtils","parseISOTimestamp","created_at","_updatedAt","updated_at","_image","image","_imageLarge","image_large","_imageSmall","image_small","_imageThumbnail","image_thumbnail","_projectEnabled","projects_enabled","_assignmentEnabled","assignment_enabled","_autoAssign","auto_assign","_hiddenOnDashboard","hidden_on_dashboard","title_field_keys","record_title_key","_titleFieldKeysJSON","load","dataSource","callback","_schemaLoaded","loadElements","allElements","element","push","async","each","cb","err","createRecord","record","Record","DefaultValues","applyDefaultValuesForElements","formValues","get","key","elementsByKey","find","dataName","elementsByDataName","toJSON","json","JSON","parse","stringify","isAssignmentEnabled","isHiddenOnDashboard","isAutoAssign","isProjectEnabled","isGeometryRequired","titleFieldKeys","reportTemplates","boundingBox","formatISOTimestamp","createdAt","updatedAt","resetOverrides","statusField","_overrideManualLocationEnabled","_overrideMediaGalleryEnabled","StatusElement","length","override","_overrideEditDurationsEnabled","overrideManualLocationEnabled","overrideMediaGalleryEnabled","overrideEditDurationsEnabled","ChildElements","includeInto"],"mappings":"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","sourcesContent":["import ChildElements from './elements/child-elements';\nimport StatusElement from './elements/status-element';\nimport DefaultValues from './values/default-values';\nimport Record from './record';\nimport async from 'async';\nimport DateUtils from './utils/date-utils';\n\nexport default class Form {\n  constructor(attributes) {\n    this.updateFromAPIAttributes(attributes);\n  }\n\n  updateFromAPIAttributes(attrs) {\n    const attributes = attrs || {};\n\n    this._id = attributes.id;\n    this._name = attributes.name;\n    this._description = attributes.description;\n    this._elementsJSON = attributes.elements;\n    this._elements = null;\n    this._statusFieldJSON = attributes.status_field;\n    this._statusField = null;\n    this._script = attributes.script;\n    this._geometryRequired = !!attributes.geometry_required;\n    this._geometryTypes = attributes.geometry_types;\n    this._reportTemplatesJSON = attributes.report_templates;\n    this._boundingBox = attributes.bounding_box;\n    this._version = attributes.version;\n    this._createdAt = DateUtils.parseISOTimestamp(attributes.created_at);\n    this._updatedAt = DateUtils.parseISOTimestamp(attributes.updated_at);\n    this._image = attributes.image;\n    this._imageLarge = attributes.image_large;\n    this._imageSmall = attributes.image_small;\n    this._imageThumbnail = attributes.image_thumbnail;\n\n    this._projectEnabled = attributes.projects_enabled != null ? !!attributes.projects_enabled : true;\n    this._assignmentEnabled = attributes.assignment_enabled != null ? !!attributes.assignment_enabled : true;\n    this._autoAssign = attributes.auto_assign != null ? !!attributes.auto_assign : false;\n    this._hiddenOnDashboard = attributes.hidden_on_dashboard != null ? !!attributes.hidden_on_dashboard : false;\n\n    if (attributes.title_field_keys || attributes.record_title_key) {\n      this._titleFieldKeysJSON = attributes.title_field_keys || [ attributes.record_title_key ];\n    } else {\n      this._titleFieldKeysJSON = [];\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  get version() {\n    return this._version;\n  }\n\n  get createdAt() {\n    return this._createdAt;\n  }\n\n  get updatedAt() {\n    return this._updatedAt;\n  }\n\n  load(dataSource, callback) {\n    if (this._schemaLoaded) {\n      callback();\n      return;\n    }\n\n    this._schemaLoaded = true;\n\n    const loadElements = [];\n\n    for (const element of this.allElements) {\n      if (element.load) {\n        loadElements.push(element);\n      }\n    }\n\n    async.each(loadElements, (element, cb) => {\n      element.load(dataSource, (err) => {\n        if (err) {\n          // TODO(zhm) We need a parameter to control what happens when there's an error. We don't\n          // want to throw right here because some actual forms have orphaned objects. We can't have this\n          // blow up here because in a migration we need to keep going even when a form is 'slightly bogus'.\n          // In some cases it might be desirable to have more strict verification of the choice lists and\n          // classification sets.\n        }\n\n        cb();\n      });\n    }, callback);\n  }\n\n  createRecord(attributes) {\n    const record = new Record(attributes, this);\n\n    DefaultValues.applyDefaultValuesForElements(this.elements,\n                                                record.formValues,\n                                                record);\n\n    return record;\n  }\n\n  get statusField() {\n    if (!this._statusField) {\n      this._statusField = new StatusElement(this, this._statusFieldJSON);\n    }\n    return this._statusField;\n  }\n\n  get(key) {\n    return this.elementsByKey[key];\n  }\n\n  find(dataName) {\n    return this.elementsByDataName[dataName];\n  }\n\n  get hasHiddenParent() {\n    return false;\n  }\n\n  get isProjectEnabled() {\n    return this._projectEnabled;\n  }\n\n  get isAssignmentEnabled() {\n    return this._assignmentEnabled;\n  }\n\n  get isAutoAssign() {\n    return this._autoAssign;\n  }\n\n  get isHiddenOnDashboard() {\n    return this._hiddenOnDashboard;\n  }\n\n  get boundingBox() {\n    return this._boundingBox;\n  }\n\n  get image() {\n    return this._image;\n  }\n\n  get imageLarge() {\n    return this._imageLarge;\n  }\n\n  get imageSmall() {\n    return this._imageSmall;\n  }\n\n  get imageThumbnail() {\n    return this._imageThumbnail;\n  }\n\n  toJSON() {\n    const json = {};\n\n    json.id = this.id || null;\n    json.name = this.name || null;\n    json.description = this.description || null;\n    json.script = this.script || null;\n    json.elements = JSON.parse(JSON.stringify(this._elementsJSON));\n    json.assignment_enabled = this.isAssignmentEnabled;\n    json.hidden_on_dashboard = this.isHiddenOnDashboard;\n    json.auto_assign = this.isAutoAssign;\n    json.projects_enabled = this.isProjectEnabled;\n    json.geometry_required = this.isGeometryRequired;\n    json.geometry_types = this._geometryTypes;\n    json.title_field_keys = this.titleFieldKeys;\n    json.report_templates = this.reportTemplates;\n    json.bounding_box = this.boundingBox;\n    json.version = this.version;\n    json.created_at = DateUtils.formatISOTimestamp(this.createdAt);\n    json.updated_at = DateUtils.formatISOTimestamp(this.updatedAt);\n\n    if (this._statusFieldJSON) {\n      json.status_field = JSON.parse(JSON.stringify(this._statusFieldJSON));\n    }\n\n    return json;\n  }\n\n  get isGeometryEnabled() {\n    return this._geometryTypes && this._geometryTypes.length > 0;\n  }\n\n  get isGeometryRequired() {\n    return this._geometryRequired;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  get description() {\n    return this._description;\n  }\n\n  get script() {\n    return this._script;\n  }\n\n  get titleFieldKeys() {\n    return this._titleFieldKeysJSON || [];\n  }\n\n  get reportTemplates() {\n    return this._reportTemplatesJSON || [];\n  }\n\n  get reportTemplate() {\n    return this.reportTemplates.length ? this.reportTemplates[0] : null;\n  }\n\n  set overrideManualLocationEnabled(override) {\n    this._overrideManualLocationEnabled = override;\n  }\n\n  get isManualLocationEnabled() {\n    return this._overrideManualLocationEnabled != null ? !!this._overrideManualLocationEnabled : true;\n  }\n\n  set overrideMediaGalleryEnabled(override) {\n    this._overrideMediaGalleryEnabled = override;\n  }\n\n  get isMediaGalleryEnabled() {\n    return this._overrideMediaGalleryEnabled != null ? !!this._overrideMediaGalleryEnabled : true;\n  }\n\n  set overrideEditDurationsEnabled(override) {\n    this._overrideEditDurationsEnabled = override;\n  }\n\n  get isEditDurationsEnabled() {\n    return this._overrideEditDurationsEnabled != null ? !!this._overrideEditDurationsEnabled : true;\n  }\n\n  get overrideValues() {\n    return {\n      overrideManualLocationEnabled: this._overrideManualLocationEnabled,\n      overrideMediaGalleryEnabled: this._overrideMediaGalleryEnabled,\n      overrideEditDurationsEnabled: this._overrideEditDurationsEnabled\n    };\n  }\n\n  resetOverrides() {\n    for (const element of this.elements) {\n      element.resetOverrides();\n    }\n\n    this.statusField.resetOverrides();\n\n    this._overrideManualLocationEnabled = null;\n    this._overrideMediaGalleryEnabled = null;\n  }\n}\n\nChildElements.includeInto(Form);\n"],"file":"form.js"}