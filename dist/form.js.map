{"version":3,"sources":["../src/form.js"],"names":["Form","attributes","updateFromAPIAttributes","attrs","_id","id","_name","name","_description","description","_elementsJSON","elements","_elements","_statusFieldJSON","status_field","_statusField","_script","script","_geometryRequired","geometry_required","_geometryTypes","geometry_types","_reportTemplatesJSON","report_templates","_boundingBox","bounding_box","_projectEnabled","projects_enabled","_assignmentEnabled","assignment_enabled","_autoAssign","auto_assign","title_field_keys","record_title_key","_titleFieldKeysJSON","load","dataSource","callback","_schemaLoaded","loadElements","allElements","element","push","each","cb","err","createRecord","record","applyDefaultValuesForElements","formValues","get","key","elementsByKey","find","dataName","elementsByDataName","toJSON","json","JSON","parse","stringify","isAssignmentEnabled","isAutoAssign","isProjectEnabled","isGeometryRequired","titleFieldKeys","reportTemplates","boundingBox","resetOverrides","statusField","_overrideManualLocationEnabled","_overrideMediaGalleryEnabled","length","override","_overrideEditDurationsEnabled","overrideManualLocationEnabled","overrideMediaGalleryEnabled","overrideEditDurationsEnabled","includeInto"],"mappings":"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","file":"form.js","sourcesContent":["import ChildElements from './elements/child-elements';\nimport StatusElement from './elements/status-element';\nimport DefaultValues from './values/default-values';\nimport Record from './record';\nimport async from 'async';\n\nexport default class Form {\n  constructor(attributes) {\n    this.updateFromAPIAttributes(attributes);\n  }\n\n  updateFromAPIAttributes(attrs) {\n    const attributes = attrs || {};\n\n    this._id = attributes.id;\n    this._name = attributes.name;\n    this._description = attributes.description;\n    this._elementsJSON = attributes.elements;\n    this._elements = null;\n    this._statusFieldJSON = attributes.status_field;\n    this._statusField = null;\n    this._script = attributes.script;\n    this._geometryRequired = !!attributes.geometry_required;\n    this._geometryTypes = attributes.geometry_types;\n    this._reportTemplatesJSON = attributes.report_templates;\n    this._boundingBox = attributes.bounding_box;\n\n    this._projectEnabled = attributes.projects_enabled != null ? !!attributes.projects_enabled : true;\n    this._assignmentEnabled = attributes.assignment_enabled != null ? !!attributes.assignment_enabled : true;\n    this._autoAssign = attributes.auto_assign != null ? !!attributes.auto_assign : false;\n\n    if (attributes.title_field_keys || attributes.record_title_key) {\n      this._titleFieldKeysJSON = attributes.title_field_keys || [ attributes.record_title_key ];\n    } else {\n      this._titleFieldKeysJSON = [];\n    }\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  load(dataSource, callback) {\n    if (this._schemaLoaded) {\n      callback();\n      return;\n    }\n\n    this._schemaLoaded = true;\n\n    const loadElements = [];\n\n    for (const element of this.allElements) {\n      if (element.load) {\n        loadElements.push(element);\n      }\n    }\n\n    async.each(loadElements, (element, cb) => {\n      element.load(dataSource, (err) => {\n        if (err) {\n          // TODO(zhm) We need a parameter to control what happens when there's an error. We don't\n          // want to throw right here because some actual forms have orphaned objects. We can't have this\n          // blow up here because in a migration we need to keep going even when a form is 'slightly bogus'.\n          // In some cases it might be desirable to have more strict verification of the choice lists and\n          // classification sets.\n        }\n\n        cb();\n      });\n    }, callback);\n  }\n\n  createRecord(attributes) {\n    const record = new Record(attributes, this);\n\n    DefaultValues.applyDefaultValuesForElements(this.elements,\n                                                record.formValues,\n                                                record);\n\n    return record;\n  }\n\n  get statusField() {\n    if (!this._statusField) {\n      this._statusField = new StatusElement(this, this._statusFieldJSON);\n    }\n    return this._statusField;\n  }\n\n  get(key) {\n    return this.elementsByKey[key];\n  }\n\n  find(dataName) {\n    return this.elementsByDataName[dataName];\n  }\n\n  get hasHiddenParent() {\n    return false;\n  }\n\n  get isProjectEnabled() {\n    return this._projectEnabled;\n  }\n\n  get isAssignmentEnabled() {\n    return this._assignmentEnabled;\n  }\n\n  get isAutoAssign() {\n    return this._autoAssign;\n  }\n\n  get boundingBox() {\n    return this._boundingBox;\n  }\n\n  toJSON() {\n    const json = {};\n\n    json.id = this.id || null;\n    json.name = this.name || null;\n    json.description = this.description || null;\n    json.script = this.script || null;\n    json.elements = JSON.parse(JSON.stringify(this._elementsJSON));\n    json.assignment_enabled = this.isAssignmentEnabled;\n    json.auto_assign = this.isAutoAssign;\n    json.projects_enabled = this.isProjectEnabled;\n    json.geometry_required = this.isGeometryRequired;\n    json.geometry_types = this._geometryTypes;\n    json.title_field_keys = this.titleFieldKeys;\n    json.report_templates = this.reportTemplates;\n    json.bounding_box = this.boundingBox;\n\n    if (this._statusFieldJSON) {\n      json.status_field = JSON.parse(JSON.stringify(this._statusFieldJSON));\n    }\n\n    return json;\n  }\n\n  get isGeometryEnabled() {\n    return this._geometryTypes && this._geometryTypes.length > 0;\n  }\n\n  get isGeometryRequired() {\n    return this._geometryRequired;\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  get description() {\n    return this._description;\n  }\n\n  get script() {\n    return this._script;\n  }\n\n  get titleFieldKeys() {\n    return this._titleFieldKeysJSON || [];\n  }\n\n  get reportTemplates() {\n    return this._reportTemplatesJSON || [];\n  }\n\n  get reportTemplate() {\n    return this.reportTemplates.length ? this.reportTemplates[0] : null;\n  }\n\n  set overrideManualLocationEnabled(override) {\n    this._overrideManualLocationEnabled = override;\n  }\n\n  get isManualLocationEnabled() {\n    return this._overrideManualLocationEnabled != null ? !!this._overrideManualLocationEnabled : true;\n  }\n\n  set overrideMediaGalleryEnabled(override) {\n    this._overrideMediaGalleryEnabled = override;\n  }\n\n  get isMediaGalleryEnabled() {\n    return this._overrideMediaGalleryEnabled != null ? !!this._overrideMediaGalleryEnabled : true;\n  }\n\n  set overrideEditDurationsEnabled(override) {\n    this._overrideEditDurationsEnabled = override;\n  }\n\n  get isEditDurationsEnabled() {\n    return this._overrideEditDurationsEnabled != null ? !!this._overrideEditDurationsEnabled : true;\n  }\n\n  get overrideValues() {\n    return {\n      overrideManualLocationEnabled: this._overrideManualLocationEnabled,\n      overrideMediaGalleryEnabled: this._overrideMediaGalleryEnabled,\n      overrideEditDurationsEnabled: this._overrideEditDurationsEnabled\n    };\n  }\n\n  resetOverrides() {\n    for (const element of this.elements) {\n      element.resetOverrides();\n    }\n\n    this.statusField.resetOverrides();\n\n    this._overrideManualLocationEnabled = null;\n    this._overrideMediaGalleryEnabled = null;\n  }\n}\n\nChildElements.includeInto(Form);\n"]}