{"version":3,"sources":["../../src/media/track-player.js"],"names":["TrackPlayer","track","firstSegment","firstTimestamp","firstPoint","time","lastTimestamp","lastSegment","lastPoint","duration","firstTimeStamp","findPreviousTrackPointIndexes","segmentIndex","pointIndex","timestamp","milliseconds","segments","segment","points","point","Math","max","length","findPreviousTrackPoint","findNextTrackPoint","trackTime","nextPoint","nextTimestamp","lastLatitude","latitude","lastLongitude","longitude","nextLatitude","nextLongitude","isLastPointInvalid","isNextPointInvalid","range","percentage","lastLocation","nextLocation","lon","lat","location","headingDiff","viewport","courseDiff","course","accuracyDiff","horizontalAccuracy","lastAltitude","altitude","nextAltitude","lastSpeed","speed","nextSpeed","altitudeDiff","speedDiff","abs","heading","accuracy","prev","next"],"mappings":";;;;;;IAAqBA,W;AACnB,uBAAYC,KAAZ,EAAmB;AAAA;;AACjB,SAAKA,KAAL,GAAaA,KAAb;;AAEA,QAAI,KAAKA,KAAL,CAAWC,YAAf,EAA6B;AAC3B,WAAKC,cAAL,GAAsB,KAAKF,KAAL,CAAWC,YAAX,CAAwBE,UAAxB,CAAmCC,IAAzD;AACA,WAAKC,aAAL,GAAqB,KAAKL,KAAL,CAAWM,WAAX,CAAuBC,SAAvB,CAAiCH,IAAtD;AACA,WAAKI,QAAL,GAAgB,KAAKH,aAAL,GAAqB,KAAKI,cAA1C;AACD;AACF;;wBAEDC,6B,0CAA8BN,I,EAAM;AAClC,QAAIO,eAAe,CAAnB;AACA,QAAIC,aAAa,CAAjB;;AAEA,QAAIC,YAAY,IAAhB;;AAEA,QAAMC,eAAeV,IAArB;;AAEA,yBAAsB,KAAKJ,KAAL,CAAWe,QAAjC,kHAA2C;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,UAAhCC,OAAgC;;AACzC,4BAAoBA,QAAQC,MAA5B,yHAAoC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,YAAzBC,KAAyB;;AAClCL,oBAAYK,MAAMd,IAAlB;;AAEA,YAAIS,YAAYC,YAAhB,EAA8B;AAC5B,iBAAO,CAAEH,YAAF,EAAgBQ,KAAKC,GAAL,CAAS,CAAT,EAAYR,aAAa,CAAzB,CAAhB,CAAP;AACD;;AAED,UAAEA,UAAF;AACD;;AAED,QAAED,YAAF;AACD;;AAED;AACA,QAAIG,gBAAgB,KAAKT,aAAzB,EAAwC;AACtC,aAAO,CAAE,KAAKL,KAAL,CAAWe,QAAX,CAAoBM,MAApB,GAA6B,CAA/B,EAAkC,KAAKrB,KAAL,CAAWM,WAAX,CAAuBW,MAAvB,CAA8BI,MAA9B,GAAuC,CAAzE,CAAP;AACD;;AAED,WAAO,CAAE,CAAF,EAAK,CAAL,CAAP;AACD,G;;wBAEDC,sB,mCAAuBlB,I,EAAM;AAAA,gCACU,KAAKM,6BAAL,CAAmCN,IAAnC,CADV;AAAA,QACnBO,YADmB;AAAA,QACLC,UADK;;AAE3B,WAAO,KAAKZ,KAAL,CAAWe,QAAX,CAAoBJ,YAApB,EAAkCM,MAAlC,CAAyCL,UAAzC,CAAP;AACD,G;;wBAEDW,kB,+BAAmBnB,I,EAAM;AAAA,iCACc,KAAKM,6BAAL,CAAmCN,IAAnC,CADd;AAAA,QACfO,YADe;AAAA,QACDC,UADC;;AAGvB,QAAIA,aAAa,CAAb,GAAiB,KAAKZ,KAAL,CAAWe,QAAX,CAAoBJ,YAApB,EAAkCM,MAAlC,CAAyCI,MAA9D,EAAsE;AACpE,aAAO,KAAKrB,KAAL,CAAWe,QAAX,CAAoBJ,YAApB,EAAkCM,MAAlC,CAAyCL,aAAa,CAAtD,CAAP;AACD;;AAED,WAAO,KAAKZ,KAAL,CAAWe,QAAX,CAAoBJ,YAApB,EAAkCM,MAAlC,CAAyCL,UAAzC,CAAP;AACD,G;;wBAEDM,K,kBAAMM,S,EAAW;AACf,QAAI,KAAKxB,KAAL,IAAc,IAAd,IAAsB,KAAKA,KAAL,CAAWe,QAAX,CAAoBM,MAApB,KAA+B,CAAzD,EAA4D;AAC1D,aAAO,IAAP;AACD;;AAED,QAAMjB,OAAQoB,YAAY,MAAb,GAAuB,KAAKtB,cAAzC;;AAEA,QAAMK,YAAY,KAAKe,sBAAL,CAA4BlB,IAA5B,CAAlB;AACA,QAAMqB,YAAY,KAAKF,kBAAL,CAAwBnB,IAAxB,CAAlB;;AAEA,QAAMC,gBAAgBE,UAAUH,IAAhC;AACA,QAAMsB,gBAAgBD,UAAUrB,IAAhC;;AAEA,QAAMuB,eAAepB,UAAUqB,QAA/B;AACA,QAAMC,gBAAgBtB,UAAUuB,SAAhC;;AAEA,QAAMC,eAAeN,UAAUG,QAA/B;AACA,QAAMI,gBAAgBP,UAAUK,SAAhC;;AAEA,QAAMG,qBAAqBN,gBAAgB,IAAhB,IAAwBE,iBAAiB,IAApE;AACA,QAAMK,qBAAqBH,gBAAgB,IAAhB,IAAwBC,iBAAiB,IAApE;;AAEA,QAAIC,sBAAsBC,kBAA1B,EAA8C;AAC5C,aAAO,IAAP;AACD;;AAED,QAAMC,QAAQT,gBAAgBrB,aAA9B;AACA,QAAM+B,aAAaD,UAAU,CAAV,GAAc,CAAd,GAAkB,CAAC/B,OAAOC,aAAR,IAAyB8B,KAA9D;;AAEA,QAAME,eAAe,CAAE9B,UAAUqB,QAAZ,EAAsBrB,UAAUuB,SAAhC,CAArB;AACA,QAAMQ,eAAe,CAAEb,UAAUG,QAAZ,EAAsBH,UAAUK,SAAhC,CAArB;;AAEA,QAAMS,MAAO,CAACD,aAAa,CAAb,IAAkBD,aAAa,CAAb,CAAnB,IAAsCD,UAAvC,GAAqDC,aAAa,CAAb,CAAjE;AACA,QAAMG,MAAO,CAACF,aAAa,CAAb,IAAkBD,aAAa,CAAb,CAAnB,IAAsCD,UAAvC,GAAqDC,aAAa,CAAb,CAAjE;;AAEA,QAAMI,WAAW,CAAED,GAAF,EAAOD,GAAP,CAAjB;;AAEA,QAAIG,cAAcjB,UAAUkB,QAAV,GAAqBpC,UAAUoC,QAAjD;AACA,QAAIC,aAAanB,UAAUoB,MAAV,GAAmBtC,UAAUsC,MAA9C;;AAEA,QAAMC,eAAerB,UAAUsB,kBAAV,GAA+BxC,UAAUwC,kBAA9D;;AAEA,QAAMC,eAAezC,UAAU0C,QAA/B;AACA,QAAMC,eAAezB,UAAUwB,QAA/B;;AAEA,QAAME,YAAY5C,UAAU6C,KAA5B;AACA,QAAMC,YAAY5B,UAAU2B,KAA5B;;AAEA,QAAIE,eAAe,IAAnB;;AAEA,QAAIN,gBAAgB,IAAhB,IAAwBE,gBAAgB,IAA5C,EAAkD;AAChDI,qBAAeJ,eAAeF,YAA9B;AACD;;AAED,QAAIO,YAAY,IAAhB;;AAEA,QAAIJ,aAAa,IAAb,IAAqBE,aAAa,IAAlC,IAA0CF,YAAY,CAAC,CAAvD,IAA4DE,YAAY,CAAC,CAA7E,EAAgF;AAC9EE,kBAAYF,YAAYF,SAAxB;AACD;;AAED;;;;;;;;;;;;;AAiBA,QAAIhC,KAAKqC,GAAL,CAASd,WAAT,IAAwB,GAA5B,EAAiC;AAC/B,UAAIjB,UAAUkB,QAAV,GAAqBpC,UAAUoC,QAAnC,EAA6C;AAC3CD,sBAAc,CAACnC,UAAUoC,QAAX,IAAuB,MAAMlB,UAAUkB,QAAvC,CAAd;AACD,OAFD,MAEO;AACLD,sBAAc,EAAE,EAAE,MAAMnC,UAAUoC,QAAlB,IAA8BlB,UAAUkB,QAA1C,CAAd;AACD;AACF;;AAED,QAAIxB,KAAKqC,GAAL,CAASZ,UAAT,IAAuB,GAA3B,EAAgC;AAC9B,UAAInB,UAAUoB,MAAV,GAAmBtC,UAAUsC,MAAjC,EAAyC;AACvCD,qBAAa,CAACrC,UAAUsC,MAAX,IAAqB,MAAMpB,UAAUoB,MAArC,CAAb;AACD,OAFD,MAEO;AACLD,qBAAa,EAAE,EAAE,MAAMrC,UAAUsC,MAAlB,IAA4BpB,UAAUoB,MAAxC,CAAb;AACD;AACF;;AAED,QAAMY,UAAWf,cAAcN,UAAf,GAA6B7B,UAAUoC,QAAvD;AACA,QAAME,SAAUD,aAAaR,UAAd,GAA4B7B,UAAUsC,MAArD;AACA,QAAMa,WAAYZ,eAAeV,UAAhB,GAA8B7B,UAAUwC,kBAAzD;;AAEA,QAAIE,WAAW,IAAf;AACA,QAAIG,QAAQ,IAAZ;;AAEA,QAAIE,gBAAgB,IAApB,EAA0B;AACxBL,iBAAYK,eAAelB,UAAhB,GAA8B7B,UAAU0C,QAAnD;AACD;;AAED,QAAIM,aAAa,IAAjB,EAAuB;AACrBH,cAASG,YAAYnB,UAAb,GAA2B7B,UAAU6C,KAA7C;AACD;;AAED,WAAO;AACLhD,YAAMA,IADD;AAELqC,gBAAUA,QAFL;AAGLI,cAAQA,MAHH;AAILF,gBAAUc,OAJL;AAKLL,aAAOA,KALF;AAMLH,gBAAUA,QANL;AAOLS,gBAAUA,QAPL;AAQLC,YAAMpD,SARD;AASLqD,YAAMnC;AATD,KAAP;AAWD,G;;;;;kBA/KkB1B,W","file":"track-player.js","sourcesContent":["export default class TrackPlayer {\n  constructor(track) {\n    this.track = track;\n\n    if (this.track.firstSegment) {\n      this.firstTimestamp = this.track.firstSegment.firstPoint.time;\n      this.lastTimestamp = this.track.lastSegment.lastPoint.time;\n      this.duration = this.lastTimestamp - this.firstTimeStamp;\n    }\n  }\n\n  findPreviousTrackPointIndexes(time) {\n    let segmentIndex = 0;\n    let pointIndex = 0;\n\n    let timestamp = null;\n\n    const milliseconds = time;\n\n    for (const segment of this.track.segments) {\n      for (const point of segment.points) {\n        timestamp = point.time;\n\n        if (timestamp > milliseconds) {\n          return [ segmentIndex, Math.max(0, pointIndex - 1) ];\n        }\n\n        ++pointIndex;\n      }\n\n      ++segmentIndex;\n    }\n\n    // if the video time is beyond the end of the track, return the last index\n    if (milliseconds >= this.lastTimestamp) {\n      return [ this.track.segments.length - 1, this.track.lastSegment.points.length - 1 ];\n    }\n\n    return [ 0, 0 ];\n  }\n\n  findPreviousTrackPoint(time) {\n    const [ segmentIndex, pointIndex ] = this.findPreviousTrackPointIndexes(time);\n    return this.track.segments[segmentIndex].points[pointIndex];\n  }\n\n  findNextTrackPoint(time) {\n    const [ segmentIndex, pointIndex ] = this.findPreviousTrackPointIndexes(time);\n\n    if (pointIndex + 1 < this.track.segments[segmentIndex].points.length) {\n      return this.track.segments[segmentIndex].points[pointIndex + 1];\n    }\n\n    return this.track.segments[segmentIndex].points[pointIndex];\n  }\n\n  point(trackTime) {\n    if (this.track == null || this.track.segments.length === 0) {\n      return null;\n    }\n\n    const time = (trackTime * 1000.0) + this.firstTimestamp;\n\n    const lastPoint = this.findPreviousTrackPoint(time);\n    const nextPoint = this.findNextTrackPoint(time);\n\n    const lastTimestamp = lastPoint.time;\n    const nextTimestamp = nextPoint.time;\n\n    const lastLatitude = lastPoint.latitude;\n    const lastLongitude = lastPoint.longitude;\n\n    const nextLatitude = nextPoint.latitude;\n    const nextLongitude = nextPoint.longitude;\n\n    const isLastPointInvalid = lastLatitude == null || lastLongitude == null;\n    const isNextPointInvalid = nextLatitude == null || nextLongitude == null;\n\n    if (isLastPointInvalid || isNextPointInvalid) {\n      return null;\n    }\n\n    const range = nextTimestamp - lastTimestamp;\n    const percentage = range === 0 ? 0 : (time - lastTimestamp) / range;\n\n    const lastLocation = [ lastPoint.latitude, lastPoint.longitude ];\n    const nextLocation = [ nextPoint.latitude, nextPoint.longitude ];\n\n    const lon = ((nextLocation[1] - lastLocation[1]) * percentage) + lastLocation[1];\n    const lat = ((nextLocation[0] - lastLocation[0]) * percentage) + lastLocation[0];\n\n    const location = [ lat, lon ];\n\n    let headingDiff = nextPoint.viewport - lastPoint.viewport;\n    let courseDiff = nextPoint.course - lastPoint.course;\n\n    const accuracyDiff = nextPoint.horizontalAccuracy - lastPoint.horizontalAccuracy;\n\n    const lastAltitude = lastPoint.altitude;\n    const nextAltitude = nextPoint.altitude;\n\n    const lastSpeed = lastPoint.speed;\n    const nextSpeed = nextPoint.speed;\n\n    let altitudeDiff = null;\n\n    if (lastAltitude != null && nextAltitude != null) {\n      altitudeDiff = nextAltitude - lastAltitude;\n    }\n\n    let speedDiff = null;\n\n    if (lastSpeed != null && nextSpeed != null && lastSpeed > -1 && nextSpeed > -1) {\n      speedDiff = nextSpeed - lastSpeed;\n    }\n\n    /*\n\n    When the diff between the 2 points is greater than 180, we need\n    to reverse the direction of the tweening so it produces the fastest\n    transition between the 2 angles. By negating the different angles we\n    produce a much simpler value.\n\n    Example 1:\n      going from 30 to 350 should produce a -40 degree counterclockwise\n      result, not a 320 clockwise animation\n\n    Example 2:\n      going from 350 to 30 should produce a 40 degree clockwise\n      result, not a 320 counterclockwise animation\n\n    */\n\n    if (Math.abs(headingDiff) > 180) {\n      if (nextPoint.viewport > lastPoint.viewport) {\n        headingDiff = -lastPoint.viewport - (360 - nextPoint.viewport);\n      } else {\n        headingDiff = -(-(360 - lastPoint.viewport) - nextPoint.viewport);\n      }\n    }\n\n    if (Math.abs(courseDiff) > 180) {\n      if (nextPoint.course > lastPoint.course) {\n        courseDiff = -lastPoint.course - (360 - nextPoint.course);\n      } else {\n        courseDiff = -(-(360 - lastPoint.course) - nextPoint.course);\n      }\n    }\n\n    const heading = (headingDiff * percentage) + lastPoint.viewport;\n    const course = (courseDiff * percentage) + lastPoint.course;\n    const accuracy = (accuracyDiff * percentage) + lastPoint.horizontalAccuracy;\n\n    let altitude = null;\n    let speed = null;\n\n    if (altitudeDiff != null) {\n      altitude = (altitudeDiff * percentage) + lastPoint.altitude;\n    }\n\n    if (speedDiff != null) {\n      speed = (speedDiff * percentage) + lastPoint.speed;\n    }\n\n    return {\n      time: time,\n      location: location,\n      course: course,\n      viewport: heading,\n      speed: speed,\n      altitude: altitude,\n      accuracy: accuracy,\n      prev: lastPoint,\n      next: nextPoint\n    };\n  }\n}\n"]}