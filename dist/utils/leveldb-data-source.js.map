{"version":3,"sources":["../../src/utils/leveldb-data-source.js"],"names":["CACHE_VERSION","LevelDBDataSource","db","cacheVersion","callbacks","initialize","callback","formVersions","choiceListVersions","classificationSetVersions","objects","checkVersion","Object","keys","id","push","type","version","getVersions","err","versions","each","object","cb","key","del","checkAlreadyFetching","length","invokeCallbacks","handler","get","value","notFound","JSON","parse","put","stringify","join","getChoiceList","json","getClassificationSet","getForm","getChoiceListComplete","updateObject","getClassificationSetComplete","getFormComplete","updateVersion","deleteAll","createKeyStream","on"],"mappings":"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","file":"leveldb-data-source.js","sourcesContent":["import ChoiceList from '../choice-list';\nimport ClassificationSet from '../classification-set';\nimport Form from '../form';\nimport async from 'async';\n\nconst CACHE_VERSION = 1;\n\nexport default class LevelDBDataSource {\n  constructor(db, cacheVersion) {\n    this.db = db;\n    this.callbacks = [];\n    this.cacheVersion = cacheVersion || CACHE_VERSION;\n  }\n\n  initialize({formVersions, choiceListVersions, classificationSetVersions}, callback) {\n    const objects = [];\n\n    this.checkVersion(() => {\n      for (const id of Object.keys(formVersions)) {\n        objects.push({type: 'form', id, version: formVersions[id]});\n      }\n\n      for (const id of Object.keys(choiceListVersions)) {\n        objects.push({type: 'choice-list', id, version: choiceListVersions[id]});\n      }\n\n      for (const id of Object.keys(classificationSetVersions)) {\n        objects.push({type: 'classification-set', id, version: classificationSetVersions[id]});\n      }\n\n      this.getVersions((err, versions) => {\n        if (err) {\n          return callback(err);\n        }\n\n        return async.each(objects, (object, cb) => {\n          const key = this.key(object.type, object.id);\n          const version = object.version;\n\n          // delete the object from the cache if the versions don't match\n          if (versions[key] == null || (versions[key] != null && versions[key] !== version)) {\n            return this.del(key, cb);\n          }\n\n          return cb(err);\n        }, callback);\n      });\n    });\n  }\n\n  checkAlreadyFetching(id, callback) {\n    if (!this.callbacks[id]) {\n      this.callbacks[id] = [];\n    }\n\n    this.callbacks[id].push(callback);\n\n    return this.callbacks[id].length > 1;\n  }\n\n  invokeCallbacks(id, err, object) {\n    for (const handler of this.callbacks[id]) {\n      handler(err, object);\n    }\n\n    delete this.callbacks[id];\n  }\n\n  get(key, callback) {\n    return this.db.get(key, (err, value) => {\n      if (err && err.notFound) {\n        return callback(null, null);\n      }\n\n      return callback(err, value && JSON.parse(value));\n    });\n  }\n\n  del(key, callback) {\n    return this.db.del(key, callback);\n  }\n\n  put(key, value, callback) {\n    return this.db.put(key, JSON.stringify(value), callback);\n  }\n\n  key(type, id) {\n    return [ type, id ].join(':');\n  }\n\n  getChoiceList(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('choice-list', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ChoiceList(json) : null);\n    });\n  }\n\n  getClassificationSet(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('classification-set', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ClassificationSet(json) : null);\n    });\n  }\n\n  getForm(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('form', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new Form(json) : null);\n    });\n  }\n\n  getChoiceListComplete(id, object, callback) {\n    this.updateObject(this.key('choice-list', id), object, callback);\n  }\n\n  getClassificationSetComplete(id, object, callback) {\n    this.updateObject(this.key('classification-set', id), object, callback);\n  }\n\n  getFormComplete(id, object, callback) {\n    this.updateObject(this.key('form', id), object, callback);\n  }\n\n  updateObject(key, object, callback) {\n    this.put(key, object, (err) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return this.updateVersion(key, object.version, callback);\n    });\n  }\n\n  getVersions(callback) {\n    this.get('versions', (err, object) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return callback(null, object || {});\n    });\n  }\n\n  updateVersion(key, version, callback) {\n    this.getVersions((err, versions) => {\n      if (err) {\n        return callback(err);\n      }\n\n      versions[key] = version;\n\n      this.put('versions', versions, callback);\n\n      return null;\n    });\n  }\n\n  checkVersion(callback) {\n    this.get('version', (err, version) => {\n      if (err) {\n        return callback(err);\n      }\n\n      if (version !== this.cacheVersion) {\n        this.deleteAll((err) => {\n          if (err) {\n            return callback(err);\n          }\n\n          return this.put('version', this.cacheVersion, callback);\n        });\n\n        return null;\n      }\n\n      return callback();\n    });\n  }\n\n  deleteAll(callback) {\n    const keys = [];\n\n    this.db.createKeyStream()\n      .on('data', (key) => {\n        keys.push(key);\n      })\n      .on('close', () => {\n        async.each(keys, (key, cb) => {\n          this.del(key, cb);\n        }, callback);\n      });\n  }\n}\n"]}