{"version":3,"sources":["../../src/validation/feature-validator.js"],"names":["FeatureValidator","validateFeature","feature","record","formValues","Record","validateRecord","RepeatableItemValue","validateRepeatableItem","errors","isStatusFieldEnabled","status","push","RequiredFieldValidationError","form","statusField","isGeometryRequired","hasCoordinate","GeometryRequiredValidationError","cache","validateFieldsInElements","elements","repeatableItem","element","visibilityCache","isSectionElement","visible","Condition","shouldElementBeVisible","required","shouldElementBeRequired","disabled","isDisabled","validatable","fieldValue","get","key","isEmpty","isTextElement","isNumeric","textValue","error","validateNumericField","hasPattern","validatePatternOfElement","isDateElement","validateDateField","isTimeElement","validateTimeField","isLengthValidationSupported","validateLengthForElement","isRepeatableElement","repeatableValue","items","item","itemValues","copy","merge","value","regex","RegExp","pattern","test","PatternValidationError","hasMinLengthError","hasMaxLengthError","hasMinLength","length","minLength","hasMaxLength","maxLength","LengthValidationError","NumericFormatValidationError","decimalSeparator","isIntegerFormat","indexOf","numberValue","hasMin","min","hasMax","max","NumericRangeValidationError","isValid","DateFormatValidationError","TimeFormatValidationError","formatErrors","messages","message","join"],"mappings":"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","file":"feature-validator.js","sourcesContent":["import RepeatableItemValue from '../values/repeatable-item-value';\nimport Record from '../record';\nimport Condition from '../elements/condition';\nimport RequiredFieldValidationError from './required-field-validation-error';\nimport GeometryRequiredValidationError from './geometry-required-validation-error';\nimport PatternValidationError from './pattern-validation-error';\nimport LengthValidationError from './length-validation-error';\nimport NumericFormatValidationError from './numeric-format-validation-error';\nimport NumericRangeValidationError from './numeric-range-validation-error';\nimport DateFormatValidationError from './date-format-validation-error';\nimport TimeFormatValidationError from './time-format-validation-error';\n\nexport default class FeatureValidator {\n  static validateFeature(feature, record, formValues) {\n    if (feature instanceof Record) {\n      return FeatureValidator.validateRecord(record, formValues);\n    } else if (feature instanceof RepeatableItemValue) {\n      return FeatureValidator.validateRepeatableItem(feature, record, formValues);\n    }\n\n    return [];\n  }\n\n  static validateRecord(record, formValues) {\n    if (record == null) {\n      return [];\n    }\n\n    const errors = [];\n\n    if (record.isStatusFieldEnabled && record.status == null) {\n      errors.push(new RequiredFieldValidationError(record.form.statusField));\n    }\n\n    if (record.form.isGeometryRequired) {\n      if (!record.hasCoordinate) {\n        errors.push(new GeometryRequiredValidationError());\n      }\n    }\n\n    const cache = {};\n\n    this.validateFieldsInElements(record.form.elements, record, formValues, errors, cache);\n\n    return errors;\n  }\n\n  static validateRepeatableItem(repeatableItem, record, formValues) {\n    if (repeatableItem == null) {\n      return [];\n    }\n\n    const errors = [];\n\n    if (repeatableItem.element.isGeometryRequired) {\n      if (!repeatableItem.hasCoordinate) {\n        errors.push(new GeometryRequiredValidationError());\n      }\n    }\n\n    const cache = {};\n\n    FeatureValidator.validateFieldsInElements(repeatableItem.element.elements, record, formValues, errors, cache);\n\n    return errors;\n  }\n\n  static validateFieldsInElements(elements, record, formValues, errors, visibilityCache) {\n    const cache = visibilityCache || {};\n\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        const visible = Condition.shouldElementBeVisible(element, record, formValues, cache);\n\n        if (visible) {\n          FeatureValidator.validateFieldsInElements(element.elements, record, formValues, errors, cache);\n        }\n      } else {\n        const required = Condition.shouldElementBeRequired(element, record, formValues);\n        const visible = Condition.shouldElementBeVisible(element, record, formValues, cache);\n\n        const disabled = element.isDisabled;\n\n        const validatable = (visible && !disabled);\n\n        if (validatable) {\n          if (required) {\n            const fieldValue = formValues.get(element.key);\n\n            if (fieldValue == null || fieldValue.isEmpty) {\n              errors.push(new RequiredFieldValidationError(element));\n            }\n          }\n\n          if (element.isTextElement) {\n            if (element.isNumeric) {\n              const textValue = formValues.get(element.key);\n\n              const error = FeatureValidator.validateNumericField(element, textValue);\n\n              if (error) {\n                errors.push(error);\n              }\n            } else if (element.hasPattern) {\n              const textValue = formValues.get(element.key);\n\n              const error = FeatureValidator.validatePatternOfElement(element, textValue);\n\n              if (error) {\n                errors.push(error);\n              }\n            }\n          }\n\n          if (element.isDateElement) {\n            const error = FeatureValidator.validateDateField(element, formValues.get(element.key));\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n\n          if (element.isTimeElement) {\n            const error = FeatureValidator.validateTimeField(element, formValues.get(element.key));\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n\n          if (element.isLengthValidationSupported) {\n            const fieldValue = formValues.get(element.key);\n            const error = FeatureValidator.validateLengthForElement(element, fieldValue);\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n        }\n\n        if (element.isRepeatableElement) {\n          const repeatableValue = formValues.get(element.key);\n\n          if (repeatableValue) {\n            for (const item of repeatableValue.items) {\n              const itemValues = item.formValues.copy();\n\n              itemValues.merge(formValues);\n\n              FeatureValidator.validateFieldsInElements(item.element.elements, record, itemValues, errors, null);\n            }\n          }\n        }\n      }\n    }\n  }\n\n  static validatePatternOfElement(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    const regex = new RegExp('^(?:' + element.pattern + ')$');\n\n    if (regex) {\n      if (!regex.test(value.textValue)) {\n        return new PatternValidationError(element);\n      }\n    }\n\n    return null;\n  }\n\n  static validateLengthForElement(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    let hasMinLengthError = false;\n    let hasMaxLengthError = false;\n\n    if (element.hasMinLength) {\n      hasMinLengthError = (value.length < element.minLength);\n    }\n\n    if (element.hasMaxLength) {\n      hasMaxLengthError = (value.length > element.maxLength);\n    }\n\n    if (hasMinLengthError || hasMaxLengthError) {\n      return new LengthValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateNumericField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isNumeric) {\n      return new NumericFormatValidationError(element);\n    }\n\n    // since the number is now normalized to en_US, check for the . separator\n    const decimalSeparator = '.';\n\n    if (element.isIntegerFormat) {\n      if (value.textValue.indexOf(decimalSeparator) > -1) {\n        return new NumericFormatValidationError(element);\n      }\n    }\n\n    const numberValue = +value.textValue;\n\n    if ((element.hasMin && numberValue < element.min) || (element.hasMax && numberValue > element.max)) {\n      return new NumericRangeValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateDateField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isValid) {\n      return new DateFormatValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateTimeField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isValid) {\n      return new TimeFormatValidationError(element);\n    }\n\n    return null;\n  }\n\n  static formatErrors(errors) {\n    const messages = [];\n\n    for (const error of errors) {\n      messages.push(error.message);\n    }\n\n    return messages.join('\\n\\n');\n  }\n}\n"]}